description: Scan the application dependencies for known vulnerabilities with Snyk. This command calls the others, and should be used as the command for scanning.
parameters:
  token-variable:
    description: >
      Name of env var containing your Snyk API token. Pass this as a raw string such as CICD_SNYK_TOKEN.
      Do not paste the actual token into your configuration.
      If omitted it's assumed the CLI has already been setup with a valid token beforehand.
    type: env_var_name
    default: SNYK_TOKEN
  severity-threshold:
    description: Only report vulnerabilities of provided level or higher (low/medium/high). Default is low.
    type: enum
    enum: ["low", "medium", "high"]
    default: "low"
  protect:
    description: Protect the app by applying patches specified in your .snyk file (after running the Snyk wizard)
    type: boolean
    default: false  
  fail-on-issues:
    description: This specifies if builds should be failed or continued based on issues found by Snyk.
    type: boolean
    default: true
  monitor-on-build:
    description: Take a current application dependencies snapshot for continuous monitoring by Snyk, if test was succesful.
    type: boolean
    default: true
  target-file:
    description: The path to the manifest file to be used by Snyk. Should be provided if non-standard.
    type: string
    default: ""
  docker-image-name:
    description: The image name, if scanning a container image
    type: string
    default: ""
  organization: 
    description: >
      Name of the Snyk organisation name, under which this project should be tested and monitored
      If omitted the default organization will be used.
    type: string
    default: ""
  project:
    description: >
      A custom name for the Snyk project to be created on snyk.io.
      If omitted a default-generated project name will be used.
    type: string
    default: ""
  additional-arguments:
    description: Refer to the Snyk CLI help page for information on additional arguments.
    type: string
    default: ""
  os:
    description: The CLI OS version to download
    type: enum
    enum: ["linux", "macos"]
    default: "linux"
steps:
  - install:
      os: <<parameters.os>>
      token-variable: <<parameters.token-variable>>
  - when:
      condition: <<parameters.protect>>
      steps:
        - protect:
            additional-arguments: <<parameters.additional-arguments>>
  - test:
      severity-threshold: <<parameters.severity-threshold>>
      fail-on-issues: <<parameters.fail-on-issues>>
      target-file: <<parameters.target-file>>
      docker-image-name: <<parameters.docker-image-name>>
      organization: <<parameters.organization>>
      additional-arguments: <<parameters.additional-arguments>>
  - when:
      condition: <<parameters.monitor-on-build>>
      steps:
        - monitor:
            target-file: <<parameters.target-file>>
            docker-image-name: <<parameters.docker-image-name>>
            organization: <<parameters.organization>>
            project: <<parameters.project>>
            additional-arguments: <<parameters.additional-arguments>>
